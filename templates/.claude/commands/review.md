# コードレビューコマンド

このコマンドは、コードの品質チェックとレビューを実施します。

## 概要

`/review` コマンドは、コードの品質を向上させ、潜在的な問題を早期に発見するために設計されています。以下のような観点でレビューを行います：

- セキュリティの脆弱性チェック
- パフォーマンス上の問題
- コーディング規約の遵守
- ベストプラクティスの適用
- バグの可能性

## 使い方

```
/review <レビュー対象の説明>
```

### 例

```
/review 現在のブランチの変更をレビュー
```

```
/review src/api/auth.ts のセキュリティをチェック
```

```
/review プルリクエスト #123 のレビュー
```

## プロンプト

以下のガイドラインに従ってコードレビューを実施してください：

### 1. レビューの準備

#### コンテキストの把握

- 変更の目的を理解する
- 関連するイシューやプルリクエストを確認
- 変更範囲を特定する

#### レビュー範囲の決定

- 変更されたファイルのリストアップ
- 影響を受ける可能性のある関連ファイルの特定
- テストコードの確認

### 2. レビュー観点

#### 🔒 セキュリティ（Critical）

以下のセキュリティリスクを重点的にチェック：

1. **認証・認可**
   - 適切な認証チェックがあるか
   - 権限の検証が行われているか
   - セッション管理は適切か

2. **入力検証**
   - ユーザー入力のバリデーションがあるか
   - SQL インジェクション対策がされているか
   - XSS 対策がされているか
   - CSRF 対策がされているか

3. **機密情報**
   - パスワードやAPIキーのハードコーディングがないか
   - ログに機密情報が出力されていないか
   - 環境変数で適切に管理されているか

4. **暗号化**
   - 適切な暗号化アルゴリズムを使用しているか
   - パスワードは適切にハッシュ化されているか
   - 通信は暗号化されているか

#### ⚡ パフォーマンス（High）

パフォーマンスに影響する可能性のある問題をチェック：

1. **データベースクエリ**
   - N+1 問題がないか
   - インデックスは適切に使われているか
   - 不要なクエリがないか

2. **アルゴリズム**
   - 計算量が適切か（O(n²)など遅いアルゴリズムの使用）
   - 無駄なループがないか
   - キャッシュを活用できないか

3. **リソース管理**
   - メモリリークの可能性がないか
   - ファイルハンドルは適切にクローズされているか
   - 接続は適切に管理されているか

#### 📏 コーディング規約（Medium）

プロジェクトの規約とベストプラクティスをチェック：

1. **命名規則**
   - 変数名・関数名は適切か
   - プロジェクトの命名規則に従っているか
   - わかりやすい名前になっているか

2. **コード構造**
   - 適切に関数・クラスに分割されているか
   - 単一責任の原則に従っているか
   - DRY 原則が守られているか

3. **コメント・ドキュメント**
   - 複雑なロジックにコメントがあるか（日本語）
   - docstring が適切に記述されているか
   - TODO コメントが適切に管理されているか

#### 🐛 バグの可能性（High）

潜在的なバグをチェック：

1. **エラーハンドリング**
   - 例外処理が適切か
   - エラーメッセージは有用か
   - エラー時の挙動は適切か

2. **エッジケース**
   - null/undefined のチェックがあるか
   - 空配列・空文字列の処理は適切か
   - 境界値の処理は正しいか

3. **型安全性**
   - 型定義は適切か（TypeScript/Python）
   - 型キャストは安全か
   - any 型の使用は最小限か

#### ✅ テスト（Medium）

テストの品質をチェック：

1. **テストカバレッジ**
   - 主要な機能にテストがあるか
   - エッジケースのテストがあるか
   - 十分なカバレッジがあるか

2. **テストの質**
   - テストは独立しているか
   - テストは明確か（Given-When-Then）
   - テストは壊れにくいか

### 3. レビュー結果の報告

#### レビュー結果の構成

```markdown
## レビュー結果

### 📊 概要

- レビュー対象: <ファイル名またはPR番号>
- 重要度: Critical / High / Medium / Low
- 総合評価: Approve / Request Changes / Comment

### 🔴 Critical（緊急対応が必要）

1. **<問題のタイトル>**
   - ファイル: `<ファイルパス>:<行番号>`
   - 問題: <問題の説明>
   - 推奨: <修正方法の提案>

### 🟠 High（優先対応が必要）

<同様の形式で記述>

### 🟡 Medium（改善推奨）

<同様の形式で記述>

### 🟢 Low（改善提案）

<同様の形式で記述>

### ✨ Good Points（良い点）

<良い実装や改善点をポジティブにフィードバック>

### 💡 提案

<さらなる改善案があれば提案>
```

## 例: API エンドポイントのレビュー

### ユーザーの入力

```
/review src/api/users.ts の認証処理をレビュー
```

### 期待される出力

```markdown
## レビュー結果

### 📊 概要

- レビュー対象: `src/api/users.ts`
- 重要度: High
- 総合評価: Request Changes

### 🔴 Critical

1. **SQLインジェクションの脆弱性**
   - ファイル: `src/api/users.ts:45`
   - 問題: ユーザー入力を直接SQLクエリに埋め込んでいます
   ```typescript
   const query = `SELECT * FROM users WHERE email = '${email}'`;
   ```
   - 推奨: パラメータ化クエリを使用してください
   ```typescript
   const query = 'SELECT * FROM users WHERE email = ?';
   const result = await db.query(query, [email]);
   ```

### 🟠 High

1. **パスワードが平文で保存**
   - ファイル: `src/api/users.ts:78`
   - 問題: パスワードがハッシュ化されずに保存されています
   - 推奨: bcrypt などでハッシュ化してください

### 🟡 Medium

1. **エラーハンドリングが不十分**
   - ファイル: `src/api/users.ts:92`
   - 問題: try-catch がありますが、エラー情報が不十分です
   - 推奨: ログにスタックトレースを含めてください

### ✨ Good Points

- REST APIの設計が適切です
- 変数名がわかりやすく、コードの可読性が高いです
- JSDocが適切に記述されています

### 💡 提案

- レート制限の実装を検討してください（ブルートフォース攻撃対策）
- 認証トークンの有効期限チェックを追加してください
```

## カスタマイズ

### レビュー観点の追加

プロジェクト固有のレビュー観点を追加できます：

```markdown
### プロジェクト固有の観点

#### アクセシビリティ
- ARIA 属性が適切に使われているか
- キーボード操作が可能か

#### 多言語対応
- 文字列がハードコードされていないか
- i18n が適切に使われているか
```

### 自動チェックとの連携

静的解析ツールの結果を参照するよう指示できます：

```markdown
## 自動チェックツールの結果を確認

- ESLint のエラー・警告を確認
- TypeScript の型エラーを確認
- テストカバレッジを確認
- SonarQube の結果を確認
```

### レビューレベルの設定

レビューの厳密さを調整できます：

```markdown
## レビューレベル

- **Strict**: すべての観点を厳密にチェック
- **Normal**: 重要な観点を中心にチェック
- **Quick**: Critical と High のみチェック
```

## 注意事項

### ポジティブなフィードバック

- 問題点の指摘だけでなく、良い点も必ず伝える
- 建設的なトーンを維持する
- 具体的な改善案を提示する

### 優先順位の明確化

- Critical、High、Medium、Low で重要度を明示
- 緊急対応が必要なものを明確にする

### コンテキストの理解

- コードの背景や制約を理解する
- 既存のアーキテクチャを尊重する
- トレードオフを考慮する

## トラブルシューティング

### レビューが表面的になってしまう

- ファイルの内容を詳細に確認してください
- 関連ファイルも参照してください
- 変更の影響範囲を広く考えてください

### 誤った指摘をしてしまう

- コードのコンテキストを十分に理解してください
- プロジェクトの規約を確認してください
- 不明な点は質問として提示してください

---

**更新日**: 2025-10-20
