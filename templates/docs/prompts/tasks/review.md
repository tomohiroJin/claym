# コードレビュープロンプト

効果的なコードレビューを行うためのチェックリストとガイドラインです。

## 目的

- コードの品質を向上させる
- バグを早期に発見する
- 知識を共有する
- プロジェクトの標準を維持する

## レビューの心構え

### レビュアーとして

1. **建設的であること**
   - 批判ではなく、改善提案を
   - "Why"を説明する

2. **具体的であること**
   - 曖昧な指摘は避ける
   - 代替案を提示する

3. **優先順位をつける**
   - 重要な問題から指摘
   - 些細な問題は「nit:」と明示

4. **学びの姿勢**
   - 自分の知らない技術があれば質問する
   - 良いコードは称賛する

### レビュイー（作成者）として

1. **説明責任**
   - PRの説明を丁寧に書く
   - 設計判断の理由を明記

2. **オープンマインド**
   - フィードバックを受け入れる
   - 防御的にならない

3. **迅速な対応**
   - コメントには早めに返信
   - 修正も速やかに

## レビューチェックリスト

### 1. 概要の確認

- [ ] PRの説明は明確か
- [ ] Issue/タスクとの関連が明示されているか
- [ ] 変更の目的が理解できるか
- [ ] 変更のスコープは適切か（大きすぎないか）

### 2. 設計・アーキテクチャ

- [ ] 設計は適切か
- [ ] 既存のパターンに従っているか
- [ ] SOLID原則に従っているか
  - **S**ingle Responsibility（単一責任）
  - **O**pen/Closed（開放/閉鎖）
  - **L**iskov Substitution（リスコフの置換）
  - **I**nterface Segregation（インターフェース分離）
  - **D**ependency Inversion（依存性逆転）
- [ ] 適切な抽象化レベルか
- [ ] オーバーエンジニアリングしていないか

**指摘例**:
```markdown
この機能は UserService クラスに追加するより、
新しい EmailService クラスに分離した方が
単一責任の原則に従いますね。

```python
# 提案
class EmailService:
    def send_welcome_email(self, user):
        ...
```
```

### 3. コードの品質

#### 可読性

- [ ] コードは読みやすいか
- [ ] 命名は適切か（変数、関数、クラス）
- [ ] マジックナンバーがないか
- [ ] ネストが深すぎないか（3階層以下）
- [ ] 関数は短いか（20行以下推奨）

**指摘例**:
```markdown
nit: 変数名 `d` は意味が不明瞭です。
`discount_rate` や `discount_amount` のように
具体的な名前をつけてください。
```

#### 複雑度

- [ ] 循環的複雑度は適切か（10以下）
- [ ] 条件分岐は単純化できないか
- [ ] 早期リターンを活用しているか

**指摘例**:
```markdown
この条件分岐は複雑すぎます。ガード句を使って
早期リターンすることで簡略化できます：

```python
def process(data):
    if not data:
        return None
    if not data.is_valid():
        raise ValidationError()
    # メインロジック
    return result
```
```

#### DRY（Don't Repeat Yourself）

- [ ] コードの重複はないか
- [ ] 共通化できる部分はないか

### 4. 正確性

- [ ] ロジックは正しいか
- [ ] エッジケースを考慮しているか
- [ ] エラーハンドリングは適切か
- [ ] Null/未定義のチェックがあるか
- [ ] 境界値の処理は正しいか

**チェックポイント**:
```markdown
[] 空の配列/リストの場合
[] Null/None の場合
[] 最大値/最小値の場合
[] 負の数の場合
[] ゼロの場合
```

### 5. パフォーマンス

- [ ] 不要なループはないか
- [ ] O(n²)以上のアルゴリズムは妥当か
- [ ] データベースクエリは最適化されているか
- [ ] N+1問題が発生していないか
- [ ] キャッシュを活用できないか
- [ ] メモリリークの可能性はないか

**指摘例**:
```markdown
⚠️ このループ内でDBクエリを実行しているため、
N+1問題が発生します。一括取得を検討してください：

```python
# 改善前
for user in users:
    profile = db.get_profile(user.id)  # N回クエリ

# 改善後
user_ids = [u.id for u in users]
profiles = db.get_profiles_bulk(user_ids)  # 1回のクエリ
```
```

### 6. セキュリティ

- [ ] 入力値の検証があるか
- [ ] SQLインジェクション対策されているか
- [ ] XSS対策されているか
- [ ] CSRF対策されているか
- [ ] 認証・認可が適切か
- [ ] 機密情報がハードコードされていないか
- [ ] ログに機密情報が出力されていないか

**指摘例**:
```markdown
🚨 セキュリティ: ユーザー入力をそのままSQLクエリに
埋め込んでいます。SQLインジェクションの脆弱性があります。
プリペアドステートメントを使用してください：

```python
# NG
query = f"SELECT * FROM users WHERE id = {user_id}"

# OK
query = "SELECT * FROM users WHERE id = ?"
db.execute(query, (user_id,))
```
```

### 7. テスト

- [ ] テストは十分か
- [ ] カバレッジは適切か（80%以上推奨）
- [ ] エッジケースのテストがあるか
- [ ] テストは理解しやすいか
- [ ] テストは独立しているか（他のテストに依存していない）
- [ ] テストの命名は明確か

**テストレビューのポイント**:
```python
def test_calculate_discount_for_premium_users():
    """
    Good: テスト名から何をテストしているか明確
    """
    # Arrange
    user = create_premium_user()

    # Act
    discount = calculate_discount(user)

    # Assert
    assert discount == 0.2  # 20% discount
```

### 8. ドキュメント

- [ ] APIドキュメントは更新されているか
- [ ] コメントは適切か（「何を」ではなく「なぜ」）
- [ ] 複雑なロジックに説明があるか
- [ ] README/CHANGELOGは更新されているか
- [ ] 使用例があるか

**指摘例**:
```markdown
この関数は公開APIなので、docstringを追加してください：

```python
def calculate_shipping_cost(weight, distance):
    """
    配送料を計算する

    Args:
        weight (float): 荷物の重量（kg）
        distance (float): 配送距離（km）

    Returns:
        float: 配送料（円）

    Raises:
        ValueError: 重量または距離が負の場合

    Examples:
        >>> calculate_shipping_cost(5.0, 100.0)
        1500.0
    """
    ...
```
```

### 9. 互換性

- [ ] 既存のAPIとの互換性は保たれているか
- [ ] 破壊的変更がある場合、移行パスが提供されているか
- [ ] バージョン間の互換性は考慮されているか
- [ ] 依存関係のバージョンは適切か

### 10. スタイル・規約

- [ ] コーディング規約に従っているか
- [ ] インデントは統一されているか
- [ ] 命名規則に従っているか
- [ ] リンターが通っているか
- [ ] フォーマッターが適用されているか

## レビューコメントのテンプレート

### 重大な問題

```markdown
🚨 **重大**: [問題の説明]

[具体的な問題点]

**推奨される修正**:
```[language]
[修正後のコード]
```

**理由**: [なぜこの修正が必要か]
```

### 改善提案

```markdown
💡 **提案**: [提案内容]

現在の実装でも動作しますが、以下のようにすると
[メリット]が得られます：

```[language]
[提案するコード]
```
```

### 質問

```markdown
❓ **質問**: [質問内容]

この実装の意図を教えてください。
[具体的に知りたいこと]
```

### 軽微な指摘

```markdown
nit: [軽微な指摘]

[簡単な説明]
```

### 称賛

```markdown
👍 **Good**: [良い点]

[具体的に何が良いか]
```

## レビューのフロー

### 1. 初回レビュー（30分以内）

- [ ] PRの説明を読む
- [ ] 変更ファイルリストを確認
- [ ] 大きな設計上の問題がないか確認
- [ ] 重大な問題があれば早期に指摘

### 2. 詳細レビュー

- [ ] コードを1ファイルずつレビュー
- [ ] チェックリストに従って確認
- [ ] コメントを記入
- [ ] 全体の印象をまとめる

### 3. フォローアップ

- [ ] 作成者の返信を確認
- [ ] 修正内容をレビュー
- [ ] 承認またはさらなるフィードバック

## レビューのベストプラクティス

### DO（すべきこと）

1. **早めにレビュー**
   - 24時間以内に初回レビュー

2. **具体的に指摘**
   - コード例を示す
   - 理由を説明する

3. **優先順位を明示**
   - 🚨: 重大（修正必須）
   - ⚠️: 重要（修正推奨）
   - 💡: 提案（任意）
   - nit: 軽微（任意）

4. **良い点も指摘**
   - 👍でポジティブフィードバック

5. **質問する**
   - わからないことは素直に質問

### DON'T（避けること）

1. **曖昧な指摘**
   - ❌「これは良くない」
   - ✅「ここは○○の理由で△△にした方が良い」

2. **感情的な表現**
   - ❌「こんなコードはあり得ない」
   - ✅「このアプローチは○○の問題があります」

3. **過度な完璧主義**
   - 些細な指摘ばかりしない
   - 重要な問題に集中

4. **スタイルの議論**
   - リンター/フォーマッターで自動化
   - チーム標準に従う

## レビュー時間の目安

| PRのサイズ | レビュー時間 |
|-----------|------------|
| 小（〜100行） | 10-15分 |
| 中（100-500行） | 30-60分 |
| 大（500行〜） | 分割を検討 |

**大きなPRは分割を提案**:
```markdown
このPRは変更が大きいため、レビューが困難です。
以下のように分割してはどうでしょうか：

1. データモデルの変更
2. ビジネスロジックの実装
3. UI の実装
```

## レビュー後のアクション

### 承認（Approve）

```markdown
LGTM! 🎉

以下の点が特に良かったです：
- [良い点1]
- [良い点2]

nit のコメントは任意なので、
必要に応じて対応してください。
```

### 変更要請（Request Changes）

```markdown
いくつか修正が必要な点があります：

**必須**:
- [ ] [重大な問題1]
- [ ] [重大な問題2]

**推奨**:
- [ ] [改善提案1]

修正後に再レビューします。
```

### コメントのみ（Comment）

```markdown
いくつか質問とコメントがあります。

確認後、再度レビューしますね。
```

## トラブルシューティング

### 意見の対立

1. データ・根拠で議論
2. チーム標準を参照
3. 必要ならチーム全体で議論
4. 最終的にはテックリードが判断

### レビューが遅い

1. リマインダーを送る（丁寧に）
2. 他のレビュアーに依頼
3. レビュー時間を予定に組み込む

### 指摘が多すぎる

1. 最重要な問題に絞る
2. 残りは別Issueに
3. リンター/フォーマッターで自動化

## 完了条件

- [ ] 全てのコメントが解決または合意
- [ ] テストが全て通る
- [ ] CI/CDが通る
- [ ] 必要な承認数を獲得
- [ ] 破壊的変更の場合、チーム全体の承認

## 参考

- [Google Engineering Practices - Code Review](https://google.github.io/eng-practices/review/)
- [Conventional Comments](https://conventionalcomments.org/)
- プロジェクトのレビューガイドライン
