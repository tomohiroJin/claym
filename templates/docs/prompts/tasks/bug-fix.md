# バグ修正プロンプト

バグを効率的に修正するためのチェックリストとガイドラインです。

## 目的

バグを正確に特定し、適切に修正し、再発を防止する。

## バグ修正の基本フロー

```
1. 再現 → 2. 原因特定 → 3. 修正 → 4. テスト → 5. 再発防止
```

## 実装手順

### 1. バグの再現

- [ ] バグレポートを詳しく読む
- [ ] 再現手順を確認
- [ ] ローカル環境で再現
- [ ] 再現条件を文書化

**再現手順のテンプレート**:
```markdown
## バグ再現手順

### 環境
- OS:
- バージョン:
- その他:

### 手順
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

### 期待される動作
[正常な動作]

### 実際の動作
[バグの動作]

### エラーメッセージ（あれば）
```
[エラーメッセージ]
```
```

### 2. 原因の特定

- [ ] エラーメッセージを分析
- [ ] スタックトレースを確認
- [ ] ログを確認
- [ ] デバッガでステップ実行
- [ ] 関連コードを読む

**デバッグテクニック**:

1. **バイナリサーチ**: コメントアウトで範囲を絞り込む
2. **print/ログデバッグ**: 変数の値を出力
3. **ブレークポイント**: デバッガで停止して状態を確認
4. **git bisect**: いつからバグが発生したか特定

```bash
# Git bisectでバグが混入したコミットを特定
git bisect start
git bisect bad  # 現在のコミットはバグあり
git bisect good [良好なコミット]
# テストを繰り返してバグの混入点を特定
```

### 3. ブランチ作成

```bash
git checkout -b bugfix/[バグの説明]
```

### 4. 修正方針の検討

- [ ] 複数の修正アプローチを検討
- [ ] 影響範囲を評価
- [ ] 他の箇所への影響を確認
- [ ] パフォーマンスへの影響を評価

**修正アプローチの評価基準**:
- **正確性**: バグを確実に修正できるか
- **安全性**: 副作用がないか
- **保守性**: 理解しやすく保守しやすいか
- **パフォーマンス**: 性能に悪影響がないか

### 5. テストの追加（重要）

バグ修正前に、バグを検出するテストを追加する

- [ ] バグを再現するテストケースを作成
- [ ] テストが失敗することを確認（レッドフェーズ）
- [ ] エッジケースもテスト

**バグ検出テストのテンプレート**:
```python
def test_バグ番号_バグの説明():
    """
    Issue #123: [バグの説明]

    このテストは、[具体的な問題]を検出するために追加されました。
    """
    # Arrange: バグが発生する条件を再現
    input_data = create_buggy_condition()

    # Act: 問題のある動作を実行
    result = buggy_function(input_data)

    # Assert: 期待される正しい動作を検証
    assert result == expected_correct_result
    assert not has_side_effect()
```

### 6. 修正の実装

- [ ] 最小限の変更で修正
- [ ] コーディング規約に従う
- [ ] 明確なコメントを追加
- [ ] エッジケースを考慮

**修正のポイント**:
- **最小限の変更**: 必要な部分だけを変更
- **防御的プログラミング**: 入力検証、エラーハンドリング
- **明確な意図**: コメントで「なぜ」を説明

```python
# 悪い例：変更が大きすぎる
def process_data(data):
    # 多くの変更...リファクタリングも混在
    pass

# 良い例：バグ修正のみ
def process_data(data):
    # Fix: Issue #123 - null チェックを追加
    if data is None:
        return default_value
    # 既存のロジックはそのまま
    return original_logic(data)
```

### 7. テストの実行

- [ ] 追加したテストが通ることを確認（グリーンフェーズ）
- [ ] 関連するテストが通ることを確認
- [ ] 回帰テスト（全テスト）を実行
- [ ] 手動テストで動作確認

```bash
# 特定のテストを実行
pytest tests/test_bugfix.py::test_issue_123

# 関連するテストを実行
pytest tests/related_module/

# 全テストを実行
pytest tests/

# カバレッジ確認
pytest --cov=src tests/
```

### 8. 影響範囲の確認

- [ ] 修正箇所を使用している他のコードを確認
- [ ] APIの互換性を確認
- [ ] パフォーマンスへの影響を測定
- [ ] セキュリティへの影響を確認

**影響調査のコマンド**:
```bash
# 関数の使用箇所を検索
grep -r "buggy_function" src/

# Git logで関連する変更履歴を確認
git log -p -- path/to/file.py
```

### 9. ドキュメントの更新

- [ ] CHANGELOG.md に修正を記録
- [ ] 関連するドキュメントを更新
- [ ] コメント・docstringを更新（必要に応じて）

**CHANGELOG エントリー例**:
```markdown
## [バージョン] - YYYY-MM-DD

### Fixed
- Issue #123: [バグの説明] - [修正内容] (@username)
```

### 10. コードレビュー準備

- [ ] コミットメッセージを整理
- [ ] PRの説明を準備
- [ ] 修正前後の比較を用意

**PR テンプレート（バグ修正用）**:
```markdown
## バグ修正

### Issue
Fixes #[issue番号]

### 問題
[バグの説明]

### 原因
[バグの根本原因]

### 修正内容
[どのように修正したか]

### 影響範囲
- [影響を受ける機能1]
- [影響を受ける機能2]

### テスト
- [x] バグを検出するテストを追加
- [x] 既存テストが全て通る
- [x] 手動テストで動作確認

### チェックリスト
- [x] 最小限の変更
- [x] 副作用なし
- [x] ドキュメント更新
```

## バグの種類別アプローチ

### ロジックエラー

**症状**: 意図しない結果が返される

**対処**:
- 条件分岐を見直す
- 境界値をテスト
- アルゴリズムを検証

### Null/未定義エラー

**症状**: NullPointerException, undefined など

**対処**:
```python
# 防御的チェックを追加
if value is not None:
    result = process(value)
else:
    result = default_value
```

### 競合状態（Race Condition）

**症状**: タイミングによって動作が変わる

**対処**:
- ロック・セマフォを使用
- アトミック操作を使用
- 同期処理を見直す

### メモリリーク

**症状**: メモリ使用量が増加し続ける

**対処**:
- リソースの解放を確認
- 循環参照を解消
- プロファイラで原因を特定

### パフォーマンスの問題

**症状**: 処理が遅い

**対処**:
- プロファイラでボトルネック特定
- アルゴリズムの最適化
- キャッシュの活用

## 再発防止策

### 1. テストの強化

- [ ] 回帰テストを追加
- [ ] エッジケースのテストを追加
- [ ] 統合テストを追加

### 2. コードの改善

- [ ] 防御的プログラミングを適用
- [ ] エラーハンドリングを改善
- [ ] バリデーションを強化

### 3. レビュープロセスの改善

- [ ] チェックリストに項目を追加
- [ ] 類似箇所のレビュー
- [ ] ペアプログラミングの検討

### 4. ドキュメント化

- [ ] 既知の問題をドキュメント化
- [ ] 落とし穴（Gotchas）を文書化
- [ ] ベストプラクティスを共有

## トラブルシューティング

### バグが再現しない

1. 環境の違いを確認（OS、バージョン、設定）
2. データの違いを確認
3. タイミング依存の問題を疑う
4. キャッシュをクリア

### 修正しても直らない

1. テストが本当にバグを検出しているか確認
2. 他の箇所に原因がないか確認
3. 根本原因を見逃していないか再検証
4. キャッシュや古いバイナリが残っていないか確認

### 副作用が発生する

1. 変更箇所を最小限に絞る
2. git diff で意図しない変更がないか確認
3. 依存関係を確認
4. 段階的にコミットを戻して特定

## ベストプラクティス

1. **テストファースト**: バグを再現するテストを先に書く
2. **最小限の変更**: 必要な部分だけを変更
3. **根本原因を特定**: 症状ではなく原因を修正
4. **影響範囲を把握**: 他への影響を必ず確認
5. **再発防止**: テストとドキュメントで再発を防ぐ

## 完了条件

- [ ] バグが修正されている
- [ ] バグを検出するテストが追加されている
- [ ] 既存のテストが全て通る
- [ ] 副作用がない
- [ ] ドキュメントが更新されている
- [ ] コードレビューで承認されている

## 参考

- プロジェクトのデバッグガイド
- テスト戦略ドキュメント
- 既知の問題リスト
